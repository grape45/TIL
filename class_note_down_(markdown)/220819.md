## 0819 KDT Class_note_down

### 🎯 학습 목표 : 데이터베이스 기초

#### 1. CASE

- CASE문은 특정 상황에서 데이터를 변환하여 활용 가능

- ELSE를 생략하는 경우 NULL 값이 지정됨

  ```sqlite
  CASE 
  	WHEN 조건식 THEN 식
  	WHEN 조건식 THEN 식
  	ELSE 식
  END
  
  -- 예시
  
  -- 단순조회
  SELECT id, gender FROM healthcare LIMIT 5;
  
  -- 성별 1(남자), 2(여자)
  SELECT id, CASE WHEN gender = 1 THEN '남자' WHEN gender = 2 THEN '여자' END AS 성별 FROM healthcare LIMIT 5; 
  
  -- 흡연(smoking)
  SELECT DISTINCT smoking FROM healthcare;
  
  SELECT id, smoking, CASE WHEN smoking = 1 THEN '비흡연자' WHEN smoking = 2 THEN '흡연자' WHEN smoking = 3 THEN '체인스모커' ELSE '무응답' END FROM healthcare LIMIT 50;
  
  -- 청소년(~18), 청년(~40), 중장년(~90)
  SELECT first_name, last_name, CASE WHEN age <= 18 THEN '청소년' WHEN age <= 40 THEN '청년' WHEN age <= 90 THEN '중장년' ELSE '노년' END FROM users LIMIT 10;
  ```



#### 2. 서브쿼리 --- 서브쿼리, 메인쿼리 부분 강의 다시 확인

- 서브커리는 특정한 값을 메인 쿼리에 반환하여 활용

- 실제 테이블에 없는 기준을 이용한 검색 가능

- 서브 쿼리는 소괄호로 감싸서 사용, 메인 쿼리의 칼럼을 모두 사용 가능

- 메인 쿼리는 서브 쿼리의 칼럼을 이용할 수 없음

  ```sqlite
  SELECT * FROM 테이블 WHERE 컬럼1 = (SELECT 컬럼1 FROM 테이블);
  ```

- 단일행 서브쿼리

  - 서브쿼리의 결과가 0 또는 1개인 경우
  - 단일행 비교 연산자와 함께 사용(`=`, `<`, `<=`, `>=`, `>`, `<>`)
  - **단일행 서브쿼리 - `WHERE`에서 활용**

  ```sqlite
  -- 예시1 : users에서 가장 나이가 적은 사람의 수 출력
  
  -- 서브커리 사용 x
  SELECT age, COUNT(*) FROM uesrs GROUP BY age ORDER BY age LIMIT 1;
  
  -- 서브커리 사용 O
  SELECT MIN(age) FROM users; -- 서브쿼리
  -- MIN(age)
  -- --------
  -- 15
  SELECT COUNT(*) FROM users WHERE age = 15;
  -- COUNT(*)
  -----------
  -- 39
  
  SELECT COUNT(*) FROM users WHERE age = (SELECT MIN(age) FROM users); -- 메인쿼리
  -- COUNT(*)
  -- --------
  -- 39
  ```

  > 서브쿼리 사용 시 MIN(age)가 변경이 되더라도 값을 새로 찾을 필요 없이 **자동으로 갱신됨**

  ```sqlite
  -- 예시2 : users에서 평균 계좌 잔고보다 높은 사람의 수 출력
  SELECT COUNT(*) FROM users WHERE balance > (SELECT AVG(balance) FROM users);
  
  -- COUNT(*)
  -----------
  -- 222
  ```

  ```sqlite
  -- 예시3 : 유은정과 같은 지역에 사는 사람의 수
  SELECT country FROM users WHERE last_name = '유' AND first_name = '은정'; -- 서브쿼리
  -- country
  -- -------
  -- 강원도
  
  SELECT COUNT(*) FROM users WHERE country = (SELECT country FROM users WHERE last_name = '유' AND first_name = '은정'); -- 메인쿼리
  -- COUNT(*)
  -- --------
  -- 101
  ```

  - **단일행 서브쿼리 - `SELECT`에서 활용**

  ```sqlite
  -- 예시 : 전체 인원과 평균 연봉, 평균 나이 출력
  
  -- 서브쿼리 사용 X
  SELECT COUNT(*), AVG(balance), AVG(age) FROM users;
  -- COUNT(*)  AVG(balance)  AVG(age)
  -- --------  ------------  --------
  -- 1000      151456.89     27.346
  
  -- 서브쿼리 사용 O
  SELECT (SELECT COUNT(*) FROM users) AS 총인원, (SELECT AVG(balance) FROM users) AS 평균연봉, (SELECT AVG(age) FROM users) AS 평균나이 FROM users;
  -- 총인원  평균연봉     평균나이
  -- ----  ---------  ------
  -- 1000  151456.89  27.346
  ```

  - **단일행 서브쿼리 - `UPDATE`에서 활용**

  ```sqlite
  -- 예시 : balance를 평균 연봉으로 모두 바꾸기
  UPDATE users SET balance = (SELECT AVG(balance) FROM users);
  ```

- 다중행 서브쿼리

  - 서브쿼리 결과가 2개 이상인 경우
  - 다중행 비교 연산자와 함께 사용(`IN`, `EXISTS` 등)

  - 단일행 서브쿼리 - `WHERE`에서 활용

  ```sqlite
  -- 예시 : users에서 이은정과 같은 지역에 사는 사람의 수 출력
  
  -- 서브쿼리
  SELECT country FROM users WHERE last_name = '이' AND first_name = '은정';
  -- country
  -- -------
  -- 전라북도
  -- 경상북도
  
  SELECT COUNT(*) FROM users WHERE country = (SELECT country FROM users WHERE last_name = '이' AND first_name = '은정');
  -- COUNT(*)
  -- --------
  -- 115 -> 이 결과는 전라북도와 경상북도에 사는 사람의 수를 합한 것인가? : NO
  
  -- 최종코드
  -- 메인쿼리
  SELECT COUNT(*) FROM users WHERE country IN (SELECT country FROM users WHERE last_name = '이', AND first_name = '은정');
  -- 성이 '이'이고 이름은 '은정'인 사람이 사는 지역이 2개 이상인 경우 IN을 사용
  -- COUNT(*)
  -- 218
  -- 이는 전라북도 115 + 경상북도 103을 합한 값임
  ```

  ✏️ **다중칼럼 서브쿼리**

  ```SQLITE
  -- 예시 : 특정 성씨에서 가장 얼니 사람들의 이름과 나이
  -- 서브쿼리
  SELECT last_name, MIN(age) FROM users GROUP BY last_name;
  -- last_name  MIN(age)
  -- ---------  --------
  --    강         15
  --    고         15
  --   ...        ...
  ```

  ```sqlite
  -- 최종코드
  -- 메인쿼리
  -- 특정 성씨 별로 성과 가장 어린 나이를 성씨를 기준으로 오름차순으로 성, 이름, age 형태로 출력
  SELECT last_name, first_name, age FROM users WHERE (last_name, age) IN SELECT last_name, MIN(age) FROM users GROUP BY last_name) ORDER BY last_name;
  -- last_name  first_name  age
  -- ---------  ----------  ---
  --    강          정수      15
  --    고          우진      15
  --    ..         ..       ..
  ```

  
