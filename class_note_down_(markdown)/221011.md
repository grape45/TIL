## 1011 KDT Class_note_down

### ğŸ¯ í•™ìŠµ ëª©í‘œ : Django Auth II

#### 1. Django Auth ê°œìš”

- Django Authentication System is serving both "Authentication" &"Authorization" 

  - User
  - ê¶Œí•œ ë° ê·¸ë£¹
  - ì•”í˜¸ í•´ì‹œ ì‹œìŠ¤í…œ
  - Form ë° View ë„êµ¬
  - ê¸°íƒ€ ì ìš© ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ

- í•„ìˆ˜ êµ¬ì„±ì€ `settings.py` ì˜ `INSTALLED_APPS` ì—ì„œ í™•ì¸ ê°€ëŠ¥

  - django.contrib.auth

- What is the Authentication & Authorization ?

  1. Authentication (ì¸ì¦)
     - ì‹ ì› í™•ì¸
     - ì‚¬ìš©ìê°€ ìì‹ ì´ ëˆ„êµ¬ì¸ì§€ í™•ì¸
  2. Authorization (ê¶Œí•œ, í—ˆê°€)
     - ê¶Œí•œ ë¶€ì—¬
     - ì¸ì¦ëœ ì‚¬ìš©ìê°€ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì‘ì—…ì„ ê²°ì •

- ì‚¬ì „ ì„¤ì •

  1. accounts app ìƒì„± ë° ë“±ë¡

     ```python
     $ python manage.py startapp accounts
     
     # setting.py
     INSTALLED_APPS = [
       'articles',
       'accounts',
       ...
     ]
     
     '''
     - authì™€ ê´€ë ¨ëœ ê²½ë¡œë‚˜ í‚¤ì›Œë“œë“¤ì€ Django ë‚´ë¶€ì ìœ¼ë¡œ accountsë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ë˜ë„ë¡ accountsë¡œ ì§€ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥
     - ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•´ë„ ë˜ì§€ë§Œ ë‚˜ì¤‘ì— ì¶”ê°€ ì„¤ì •ì„ í•´ì•¼ í•  ë“¤ì„ ë°©ì§€ ìœ„í•¨
     '''
     ```

  2. url ë¶„ë¦¬ ë° ë§¤í•‘

     ```python
     # accounts/urls.py
     from django.urls import path
     from . import views
     
     app_name = 'accounts'
     urlpatterns = [
       
     ]
     
     # crud/urls.py
     urlpatterns = [
       ...,
       path('accounts/', include('accounts.urls'))
     ]
     ```



#### 2. User model í™œìš©í•˜ê¸°

1. Django User Model

   - "Custom User Modelë¡œ ëŒ€ì²´í•˜ê¸°"

   - DjangoëŠ” ê¸°ë³¸ì ì¸ ì¸ì¦ ì‹œìŠ¤í…œê³¼ ì—¬ëŸ¬ ê°€ì§€ í•„ë“œê°€ í¬í•¨ëœ User Modelì„ ì œê³µ, ëŒ€ë¶€ë¶„ì˜ ê°œë°œ í™˜ê²½ì—ì„œ ê¸°ë³¸ User Modelì„ Custom User Modelë¡œ ëŒ€ì²´í•¨

   - DjangoëŠ” ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•˜ëŠ” ê²½ìš° ë¹„ë¡ User ëª¨ë¸ì´ ì¶©ë¶„í•˜ë”ë¼ë„ **ì»¤ìŠ¤í…€ User ëª¨ë¸ì„ ì„¤ì •**í•˜ëŠ” ê²ƒì„ ê°•ë ¥í•˜ê²Œ ê¶Œì¥ **(highly recommended)**

   - ì»¤ìŠ¤í…€ User ëª¨ë¸ì€ ê¸°ë³¸ User ëª¨ë¸ê³¼ ë™ì¼í•˜ê²Œ ì‘ë™í•˜ë©´ì„œë„ í•„ìš”í•œ ê²½ìš° ë‚˜ì¤‘ì— ë§ì¶¤ ì„¤ì • ê°€ëŠ¥

     âš ï¸ User ëª¨ë¸ ëŒ€ì²´ ì‘ì—…ì€ í”„ë¡œì íŠ¸ì˜ ëª¨ë“  migrations í˜¹ì€ ì²« migrateë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ì‘ì—…ì„ ë§ˆì³ì•¼ í•¨

   - ëª¨ë“  í”„ë¡œì íŠ¸ì—ì„œ Django ê¸°ë³¸ ì œê³µ `built-in User model` ì˜ ê¸°ë³¸ ì¸ì¦ ìš”êµ¬ì‚¬í•­ì´ ì ì ˆí•œ ê²ƒì´ ì•„ë‹˜ âˆµ Userëª¨ë¸ì€ ê¸°ë³¸ì ìœ¼ë¡œ usernameì„ ì‹ë³„ ê°’ìœ¼ë¡œ ì‚¬ìš©

     - íšŒì›ê°€ì… ì‹œ username ëŒ€ì‹  emailì„ ì‹ë³„ ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ì í•©í•œ ê²½ìš°

   - **DjangoëŠ” í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•  User Modelì„ ê²°ì •í•˜ëŠ” `AUTH_USER_MODEL` ì„¤ì • ê°’ìœ¼ë¡œ Default User Modelì„ ì¬ì •ì˜(override) í•  ìˆ˜ ìˆë„ë¡ í•¨**



2. AUTH_USER_MODEL

   - ê¸°ë³¸ ê°’

     ```python
     # settings.py
     AUTH_USER_MODEL = 'auth.User'
     ```

   - í”„ë¡œì íŠ¸ì—ì„œ Userë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ëª¨ë¸

   - í”„ë¡œì íŠ¸ê°€ ì§„í–‰ë˜ëŠ” ë™ì•ˆ (ëª¨ë¸ì„ ë§Œë“¤ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ í•œ í›„) **ë³€ê²½í•  ìˆ˜ ì—†ìŒ**

   - í”„ë¡œì íŠ¸ ì‹œì‘ ì‹œ ì„¤ì •í•˜ê¸° ìœ„í•œ ê²ƒì´ë©°, ì°¸ì¡°í•˜ëŠ” ëª¨ë¸ì€ ì²« ë²ˆì§¸ ë§ˆì´ê·¸ë ˆì´ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•¨ = **ì²« ë²ˆì§¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ì— í™•ì • ì§€ì–´ì•¼ í•˜ëŠ” ê°’**

     ```bash
     Q. AUTH_USER_MODELì€ settings.pyì—ì„œ ë³´ì´ì§€ ì•ŠëŠ”ë°, ì–´ë””ì— ê¸°ë³¸ ê°’ì´ ì‘ì„±ë˜ì–´ ìˆëŠ”ê°€?
     A. `settings.py` ëŠ” `global_settings.py` ë¥¼ ìƒì†ë°›ì•„ ì¬ì •ì˜í•˜ëŠ” íŒŒì¼
     ```



#### 3. ëŒ€ì²´í•˜ê¸°

- AbstractUserë¥¼ ìƒì† ë°›ëŠ” ì»¤ìŠ¤í…€ User í´ë˜ìŠ¤ ì‘ì„±

- ê¸°ì¡´ User í´ë˜ìŠ¤ë„ AbstractUserë¥¼ ìƒì†ë°›ê¸° ë•Œë¬¸ì— ì»¤ìŠ¤í…€ User í´ë˜ìŠ¤ë„ ì™„ì „íˆ ê°™ì€ ëª¨ìŠµì„ ê°€ì§

  ```python
  # accounts/models.py
  from django.contrib.auth.models import AbstractUser
  
  class User(AbstractUser):
    pass
  ```

- Django í”„ë¡œì íŠ¸ì—ì„œ Userë¥¼ ë‚˜íƒ€ë‚´ëŠ”ë° ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ì„ ë°©ê¸ˆ ìƒì„±í•œ ì»¤ìŠ¤í…€ User ëª¨ë¸ë¡œ ì§€ì •

  ```python
  # settings.py
  AUTH_USER_MODEL = 'accounts.User'
  ```

- `admin.py` ì— ì»¤ìŠ¤í…€ User ëª¨ë¸ ë“±ë¡

  - ê¸°ë³¸ User ëª¨ë¸ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ë“±ë¡í•˜ì§€ ì•Šìœ¼ë©´ admin siteì— ì¶œë ¥ë˜ì§€ ì•ŠìŒ

  ```python
  # accounts/admin.py
  from django.contrib import admin
  from django.contrib.auth.admin import UserAdmin
  from .modesl import User
  
  admin.site.register(User, UserAdmin)
  ```

âœï¸ User ëª¨ë¸ ìƒì† ê´€ê³„ (ì°¸ê³ )

`models.Model` â†’ `class AbstractBaseUser` â†’ `class AbstractUser` â†’ `class User`



#### 4. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”(ì‹¤ìŠµìš©)

1. ê¸°ë³¸ ì„¤ì •
   - ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í›„ ë§ˆì´ê·¸ë ˆì´ì…˜ (í”„ë¡œì íŠ¸ ì¤‘ê°„ì¼ ê²½ìš°)
   - migrations íŒŒì¼ ì‚­ì œ
     - migrations í´ë” ë° `__init__.py` ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ
     - ë²ˆí˜¸ê°€ ë¶™ì€ íŒŒì¼ë§Œ ì‚­ì œ
   - db.sqlite3 ì‚­ì œ
   - migrations ì§„í–‰
     - makemigrations
     - migrate



2. costom Userë¡œ ë³€ê²½ëœ í…Œì´ë¸” í™•ì¸
   - ì„¤ì • ì´í›„ auth_user í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ accounts_user í…Œì´ë¸” ì‚¬ìš©



3. User ê°ì²´ í™œìš©
   - User ê°ì²´ëŠ” ì¸ì¦ ì‹œìŠ¤í…œì˜ ê°€ì¥ ê¸°ë³¸
   - ê¸°ë³¸ ì†ì„±
     - username
     - password
     - password
     - email
     - first_name
     - last_name



4. ì•”í˜¸ ê´€ë¦¬
   - íšŒì› ê°€ì…ì‹œ ì¼ë°˜ì ìœ¼ë¡œ ì•”í˜¸(password)ë¥¼ ì €ì¥ì´ í•„ìˆ˜ì ì´ë©°, ë³„ë„ì˜ ì²˜ë¦¬ í•„ìš”
   - Djangoì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ PBKDF2 (Password-Based Key Derivation Function) ì‚¬ìš©í•˜ì—¬ ì €ì¥
     - ë‹¨ë°©í–¥ í•´ì‹œí•¨ìˆ˜ë¥¼ í™œìš©í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì´ì œìŠ¤íŠ¸ë¡œ ì•”í˜¸í™”í•˜ë©° ë³µí˜¸í™”ëŠ” ë¶ˆê°€ëŠ¥
     - ê·¸ëŸ¬ë‚˜ ë‹¨ë°©í–¥ í•´ì‹œí•¨ìˆ˜ëŠ” ë ˆì¸ë³´ìš° ê³µê²© ë° ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ë“± ë¬¸ì œ ë°œìƒ
     - ë¬¸ì œì  ë³´ì™„ì„ ìœ„í•œ ì¶”ê°€ ê¸°ë²•
       - ì†”íŒ…(Salting) : íŒ¨ìŠ¤ì›Œë“œì— ì„ì˜ì˜ ë¬¸ìì—´ì¸ saltë¥¼ ì¶”ê°€í•˜ì—¬ ë‹¤ì´ì œìŠ¤íŠ¸ ìƒì„±
       - í‚¤ ìŠ¤íŠ¸ë ˆì¹­(Key Stetching) : í•´ì‹œë¥¼ ì—¬ëŸ¬ ë²ˆ ë°˜ë³µí•˜ì—¬ ì‹œê°„ì„ ëŠ˜ë¦¼



5. User ê°ì²´ í™œìš©

   ```python
   # User ìƒì„±
   user = User.objects.create_user('join', 'john@google.com', '1q2w3e4r!')
   
   # User ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
   user = User.obejcts.get(pk=2)
   User.set_password('new password')
   User.save()
   
   # Uesr ì¸ì¦(ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
   from django.contrib.auth import authentictate
   user = authenticate(username = 'john', password = 'secret')
   ```

   

#### 5. íšŒì› ê°€ì…

1. UserCreationForm

   - ì£¼ì–´ì§„ usernameê³¼ passwordë¡œ ê¶Œí•œì´ ì—†ëŠ” ìƒˆ userë¥¼ ìƒì„±í•˜ëŠ” ModelForm
   - 3ê°œì˜ í•„ë“œë¥¼ ê°€ì§
     - username (form the user model)
     - password1
     - password2

   ```python
   # accounts/urls.py
   app_name = 'accounts'
   urlpatterns = [
     ...,
     path('signup/', views.signup, name = 'signup')
   ]
   
   <!-- accounts/signup.html -->
   {% extends 'base.html' %}
   
   {% block content %}
   <h1>íšŒì›ê°€ì…</h1>
   <form action="{% url 'accoutns:signup' %}" method = "POST">
   	{% csrf_token %}
     {{ form.as_p }}
     <input type = "submit">
   </form>
   {% endblock content %}
   
   # accounts/view.py
   from django.contrib.auth.forms import AuthenticationForm, UserCreationForm
   
   def signup(request):
     if request.method == 'POST':
       pass
     else:
       form = UserCreationForm()
     context = {
       'form' : form,
     }
     return render(request, 'accounts/signup.html', context)
   ```

   - íšŒì›ê°€ì… ë§í¬ ì‘ì„± í›„ í˜ì´ì§€ í™•ì¸

   ```html
   <!-- base.html -->
   <div class = "container">
     <a herf="{% url 'accounts:signup' %}">Signup</a>
     <hr>
     {% block content %}
     {% endblock content %}
   </div>
   ```

   - íšŒì›ê°€ì… ë¡œì§ ì‘ì„±

   ```python
   # accounts/views.py
   def signup(request):
     if request.method == 'POST':
       form = UserCreationForm(request.POST)
       if form.is_valid():
         form.save()
         return redirect('articles:index')
       else:
         form = UserCreationForm()
       context = {
         'form' : form,
       }
       return render(request, 'accounts/signup.html', context)
   ```

   - íšŒì›ê°€ì… ì§„í–‰ í›„ ì—ëŸ¬ í˜ì´ì§€ í™•ì¸

     âˆµ íšŒì›ê°€ì…ì— ì‚¬ìš©í•˜ëŠ” `UserCreationForm` ì´ ê°œë°œìê°€ ëŒ€ì²´í•œ ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì´ ì•„ë‹Œ ê¸°ì¡´ ìœ ì € ëª¨ë¸ë¡œ ì¸í•´ ì‘ì„±ëœ í´ë˜ìŠ¤ì´ê¸° ë•Œë¬¸ !



#### 6. Custom user & Built-in auth forms

- `CustomUserCreationForm()` ìœ¼ë¡œ ëŒ€ì²´í•˜ê¸°

  ```python
  # accounts/views.py
  from django.contrib.auth.forms import AUthenticationForm, UserCreationForm
  from .forms import CustomUserCreationForm, CustomUserChangeForm â­ï¸
  
  def signup(request):
    if request.method == 'POST':
      form = CustomUserCreationForm(request.POST)â­ï¸
      if form.is_valid():
        form.save()
        return redirect('articles:index')
      else:
        form = CustoomUserCreationForm()
      context = {
        'form' : form,
      }
      return render(request, 'accounts/signup.html', context)
  ```

- íšŒì›ê°€ì… ì§„í–‰ í›„ í…Œì´ë¸” í™•ì¸

- [ì°¸ê³ ] UserCreationFormì˜ save ë©”ì„œë“œ

  - userë¥¼ ë°˜í˜¸ë‚˜í•˜ëŠ” ê²ƒì„ í™•ì¸

    ```python
    def save(self, commit = True):
      user = super().save(commit = False)
      user.set_password(self.cleaned_data["password1"])
      if commit:
        user.save()
      return user
    ```
